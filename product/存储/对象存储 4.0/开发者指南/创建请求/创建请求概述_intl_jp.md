## 基本概念

Tencent Cloud COSはHTTP/HTTPSプロトコルを通じてアクセスするWeb保存サービスです。REST APIまたは[COS SDK](https://cloud.tencent.com/document/product/436/6474)を使ってCOSにアクセスすることができます。

COSにアクセスするリクエストを送信する場合、COSから認証と権限確認を受けてから、はじめてリソースを操作できます。故に、身分の識別可能性により、COSにアクセスするリクエストは2つのタイプに分けられます：匿名リクエストと署名リクエスト。

- 匿名リクエスト：リクエストにはAuthorizationまたは関連パラメータがついていない場合、もしくは関連文字でユーザーの身分特徴を識別できない場合、リクエストは匿名リクエストとされて認証されます。
- 署名リクエスト：署名のリクエストにつき、HTTPヘッダーまたはリクエストパケットにAuthorizationフィールドを加える必要があります。当該フィールドの内容はTencent Cloudのセキュリティ認証情報であるSecretID、SecretKeyとリクエストの一部の特徴値をもとに、暗号化アルゴリズムにより生成するものです。

COS SDKでアクセスする場合、セキュリティ認証情報を構成するだけでリクエストを送信できます。REST APIを使ってアクセスする場合、[リクエスト署名](https://cloud.tencent.com/document/api/436/7778)ドキュメントを参考に自らリクエスト署名を計算し、または[COS署名ツール](https://cloud.tencent.com/document/product/436/30442)により直接生成する必要があります。

## セキュリティ認証情報の取得

CAM（Cloud Access Management）はCOSに対してアカウントとセキュリティ認証情報の関連機能とサービスを提供しており、主にTencent Cloudアカウントにおけるリソースへのアクセス権限の管理に役立ちます。ユーザーはCAMを通じてユーザー（グループ）を作成・管理・終了し、また身分管理とポリシー管理を使ってその他ユーザーがTencent Cloudリソースを使用する場合の権限を管理することができます。

### ルートアカウントのセキュリティ認証情報

ルートアカウントにログインした後、CAMの[クラウドAPI暗号鍵](https://console.cloud.tencent.com/cam/capi)のページにアクセスしてルートアカウントのセキュリティ認証情報SecretIDとSecretKeyを取得・管理できます。以下はいくつかの暗号鍵の例です。

> 36の文字からなるアクセス用暗号鍵ID（SecretID）：AKIDHZRLB9Ibhdp7Y7gyQq6BOk1997BGmUXg
> 32の文字からなるアクセス用暗号鍵Key（SecretKey）：LYaWIuQmCSZ5ZMniUM6hiaLxHnW6XxRK

アクセス用暗号鍵は一意のアカウントの認証に用いられます。暗号鍵で署名してリクエストを送信し、Tencent Cloudはリクエスターの身分を識別し、また認証後、その身分、リソース、操作、条件等を認証することで、当該操作の実行可能性を判断します。

>!ルートアカウント暗号鍵はその名義下のすべてのリソースのすべての操作権限を有し、暗号鍵の漏洩はクラウドにおける資産の損失に繋がるおそれがあるため、サブアカウントを作成し、また合理的に権限を配分し、サブアカウントの暗号鍵作成リクエストを使ってリソースにアクセス・管理することをおすすめします。

### サブアカウントのセキュリティ認証情報

ご名義下のユーザーとクラウドリソースを複数の次元において管理する場合、ルートアカウントの名義下で複数のサブアカウントを作成することで、リソースに対する副管理者の権限という機能を実現できます。サブアカウントの作成関連の説明については、CAMの[ユーザー管理](https://intl.cloud.tencent.com/document/product/598/13674)の関連ドキュメントを参照してください。

サブアカウントを使ってAPIリクエストを送信する前に、サブアカウントに向けてセキュリティ認証情報を作成する必要があります。その後、サブアカウントにも身分識別用の独特の暗号鍵がつくようになります。異なるサブアカウントに対してそれぞれのユーザーポリシーを作成することで、リソースへのアクセス権限を管理できます。または、ユーザーグループを作成し、またユーザーグループに対して統一したアクセスポリシーを配分することで、人員のグルーピングとリソースの統合管理を行うことができます。

> !サブアカウントに関連権限が配分されたら、リソースを作成・変更できます。この場合、リソースが相変わらずルートアカウントに属するため、ルートアカウントは当該リソースにより生じる費用を支払う必要があります。

### 一時的なセキュリティ認証情報

ルートアカウントまたはサブアカウントのセキュリティ認証情報を使ってリソースにアクセスする以外、Tencent Cloudはロールを作成し、一時的なセキュリティ認証情報でTencent Cloudリソースを管理することをサポートします。ロール関連の基本概念と使い方については、CAMの[ロール管理](https://intl.cloud.tencent.com/document/product/598/19420)ドキュメントを参照してください。

ロールはバーチャル身分なので、ロールには永続暗号鍵がありません。Tencent CloudのCAMは一時的なセキュリティ認証情報を生成するためのSTS APIを提供します。
使い方と例詳細については、[ロールの使用](https://intl.cloud.tencent.com/document/product/598/19419)ドキュメント、または[STS API](https://intl.cloud.tencent.com/document/product/598/13895)ドキュメントにおける一時的なセキュリティ認証情報の生成方式を参照してください。一時的なセキュリティ認証情報は通常、**限定ポリシー**（操作、リソース、条件）と**限定時間**（有効の開始・終了時間）を含むため、生成した一時的なセキュリティ認証情報は自動で配布され、または直接使用されます。

一時的なセキュリティ認証情報を生成するAPIを呼び出したら、ペアである一時暗号鍵（tmpSecretId/tmpSecretKey）と一つのセキュリティートークン（sessionToken）が得られます。それらはCOSにアクセスするためのセキュリティ認証情報を構成します。以下は例を示します。

> 41の文字からなるセキュリティートークン（SecurityToken）：5e776c4216ff4d31a7c74fe194a978a3ff2a42864
> 36の文字からなる一時的アクセス用暗号鍵ID（SecretID）: AKIDcAZnqgar9ByWq6m7ucIn8LNEuY2MkPCl
> 32の一時的アクセス用暗号鍵Key（SecretKey）: VpxrX0IMCpHXWL0Wr3KQNCqJix1uhMqD

また、当該APIは`expiration`フィールドを通じて一時的なセキュリティ認証情報の有効期間を返却し、すなわち、当該セキュリティ認証情報を使ってリクエストを送信できるのはこの期間だけです。

COSは簡易サーバーSDKを通じて一時暗号鍵を生成することができます。[COS STS SDK](https://github.com/tencentyun/qcloud-cos-sts-sdk)にアクセスして取得できます。一時的なセキュリティ認証情報の取得後、REST APIを使ってリクエストを送信するには、HTTPヘッダーまたはPOSTリクエストパケットのform-dataに`x-cos-security-token`フィールドを入力して当該リクエストの使用するセキュリティートークンをマークし、そして一時的アクセス用暗号鍵ペアによりリクエスト署名を計算する必要があります。COS SDKを使ってアクセスする場合、各SDKドキュメントにおける関連説明を参照してください。

## アクセスドメイン名

### REST API

[地域とアクセスドメイン名](https://cloud.tencent.com/document/product/436/6224)ドキュメントには、REST APIアクセス用のドメイン名リストがあります。

COSはバーチャルホスティング型のドメイン名アクセスバケットを使用することをおすすめします。HTTPリクエストを送信する時、`Host`ヘッダーによるアクセス先のバケット、例えば`<BucketName-APPID>.cos.<Region>.myqcloud.com`に直接導入してください。バーチャルホスティング型のドメイン名を使ってバーチャルサーバー「ルートディレクトリ」に類似した機能を実現できます。favicon.ico、robots.txt、crossdomain.xmlのようなファイルのホスティングができます。これらのファイルは、多くのアプリがホスティングサイトを識別する時、デフォルトでバーチャルサーバー「ルートディレクトリ」から検索する内容です。

また、パス型リクエストを使ってバケットにアクセスすることもできます。例えば、`cos.<region>.myqcloud.com/<BucketName-APPID>/`のパスを使ってバケットにアクセスします。それなりに、Hostと署名のリクエストにあたって、`cos.<region>.myqcloud.com`を使用する必要があります。当社のSDKはデフォルトではこのようなアクセス方法に対応しません。

### 静的サイトのドメイン名

バケットの静的サイト機能をオンにしたら、当社はバーチャルホスティング型のドメイン名を関連機能の使用に配分します。静的サイトの表示はREST APIと異なり、特定の索引ページ、エラーページとジャンプの構成以外、静的サイトのドメイン名はGET/HEAD/OPTIONS Object等のいくつかの操作にのみ対応し、リソースのアップロードまたはリソースの構成操作に対応しません。

静的サイトのドメイン名の例：`<BucketName-APPID>.cos-website.<Region>.myqcloud.com`。また、コンソールのバケット「基本的構成 - 静的サイト構成」モジュールからこのドメイン名を取得することもできます。

## プライベートネットワークとパブリックネットワークへのアクセス

COSのアクセスドメイン名はスマートDNS解析に基づき、インターネットを通じて各通信事業者の環境で、COSアクセス用の最適化リンクを検査し、ディレクトします。Tencent CloudにCOSアクセス用のサービスを構築した場合、同じ地域におけるアクセスは自動でプライベートネットワークのアドレスにディレクトされます。地域間では、プライベートネットワークへのアクセスに対応しておらず、デフォルトではパブリックネットワークアドレスに解析します。

### プライベートネットワークへのアクセスの判断方法

同じ地域内でのTencent Cloud製品のアクセスは、自動でプライベートネットワークにより接続します。それにより生じるプライベートネットワークのトラフィックは課金されません。故にTencent Cloudの製品を購入する際、費用を抑えるため、できる限り同じ地域を選択することをおすすめします。

プライベートネットワークのアクセスであるかどうかについては、下記に示す方法を参照してください。

Tencent CVMがCOSにアクセスすることを例に、プライベートネットワークを使ってCOSにアクセスするかどうかを判断する場合、CVMにおいて`nslookup`コマンドを使ってCOSドメイン名を解析してください。プライベートネットワークIPが返却されると、CVMとCOSの間がプライベートネットワークのアクセスだとわかります。さもなければパブリックネットワークのアクセスとなります。

>?プライベートネットワークIPアドレスの一般的フォーマットは`10.*.*.*`、`100.*.*.*`で、VPCネットワークの一般的フォーマットは`169.254.*.*`等です。

`mybucket-1250000000.cos.ap-guangzhou.myqcloud.com`がターゲットバケットアドレスだとしたら、その下の`Address: 10.148.214.13`はプライベートネットワークからアクセスすることを意味します。

```shell
nslookup mybucket-1250000000.cos.ap-guangzhou.myqcloud.com

Server:         10.138.224.65
Address:        10.138.224.65  #53

Name:   mybucket-1250000000.cos.ap-guangzhou.myqcloud.com
Address: 10.148.214.13
Name:   mybucket-1250000000.cos.ap-guangzhou.myqcloud.com
Address: 10.148.214.14
```

### 接続性のテスト

#### 基本的接続テスト

COSはHTTPプロトコルを使って外部へサービスを提供します。基本的な`telnet`ツールを使ってCOSアクセスドメイン名の80ポートに対してアクセステストを行うことができます。

パブリックネットワークによるアクセス例を下記に示します。

```shell
telnet mybucket-1250000000.cos.ap-guangzhou.myqcloud.com 80
Trying 14.119.113.22...
Connected to gz.file.myqcloud.com.
Escape character is '^]'.
```

同じ地域のTencent Cloud CVM（基本ネットワーク）によるアクセス例：

```shell
telnet mybucket-1250000000.cos.ap-guangzhou.myqcloud.com 80
Trying 10.148.214.14...
Connected to 10.148.214.14.
Escape character is '^]'.
```

同じ地域のTencent Cloud CVM（VPCネットワーク）によるアクセス例：

```shell
telnet mybucket-1250000000.cos.ap-guangzhou.myqcloud.com 80
Trying 169.254.0.47....
Connected to 169.254.0.47.
Escape character is '^]'.
```

いかなるアクセス環境でも、コマンドに対して`Escape character is '^]'.`のフィールドが返却されると、接続できると説明します。

#### インターネットによるテストの説明

インターネットによりCOSにアクセスする場合、通信事業者ネットワークを経由する必要があり、通信事業者ネットワークがICMPプロトコルの`ping`または`traceroute`等のツールで接続性をテストすることを禁止する可能性があるため、TCPプロトコルのツールで接続性をテストすることをおすすめします。
>!インターネットによるアクセスは様々なネットワーク環境から影響を受けているため、アクセスがうまくいかない場合、ローカルのネットワークのリンクを逐一検査し、またはローカルの通信事業者に連絡してフィードバックしてください。

通信事業者がICMPプロトコルを許可する場合、`ping`、`traceroute`または`mtr`ツールでご利用のリンクを検査できます。通信事業者がICMPプロトコルを禁止する場合、`psping`（Windows環境。Microsoft公式サイトからダウンロードしてください）または`tcping`（マルチプラットフォームソフトウェア）等のツールで時間遅延テストを行ってください。

#### プライベートネットワークによるテストの説明

同じ地域のTencent Cloud VPCネットワークによるCOSにアクセスする場合、ICMPプロトコルの`ping`または`traceroute`等のツールで接続性をテストできない可能性があります。基本的接続テストにおける`telnet`コマンドを使ってテストすることをおすすめします。

また`psping`または`tcping`等のツールでアクセスドメイン名の80ポートに対して時間遅延テストを試しても良いです。テストする前に、`nsloopup`コマンドを使ってアクセスドメイン名がプライベートネットワークアドレスに正しく解析されていることを照合し、確認してください。
