## 機能概要
Tencent Cloud COSはホットリンク保護の構成をサポートし、セキュリティ保護のため、コンソールのホットリンク保護によりブラック/ホワイトリストを設定することをお勧めします。
<span id="ホットリンクケース"></span>
## ホットリンクケース
ユーザーAは、COSに画像リソース`1.jpg`をアップロードし、アクセス可能なリンク`http://test-1250000000.cosgz.myqcloud.com/1.jpg`を取得し、かつ自分のWebページ`http://a.com/a.html`にこの画像を埋め込み、正常にアクセスできます。
ユーザーBは、`a.com`にその画像を見て、自分のWebページ`http://b.com/b.html`に `1.jpg`のリンクを埋め込むことで、Bのページもその画像を正常に表示できるようになりました。
以上のケースにおいて、Aの画像リソース`1.jpg`はBにホットリンクされました。この時、Aが知らないままで、COS上のリソースがBのWebページに正常に使用され、Aは追加のトラフィック料金を負担したことで、料金の損失になりました。

## ホットリンク保護の判断原則
ホットリンク保護は、リクエストHeader内のRefererにより判断されます：
-  RefererはHeaderの一部であり、ブラウザがWebサーバーにリクエストを送信する時、一般にRefererも付き、このリクエストがどのページからリンクされたかをサーバーに通知し、サーバーは特定のソースからのWebサイトがリソースにアクセスすることを禁止または許可することができます。
-  ファイルリンク`http://test-1250000000.cosgz.myqcloud.com/1.jpg`がブラウザで直接的に開かれる場合、リクエストHeaderにはRefererがありません。

例えば、以下の画像について`http://127.0.0.1/test/test.html`には`1.jpg`が埋め込まれ、`test.html`にアクセスする時にアクセスソースを示すRefererが付いています：
![referer_1](//mc.qcloudimg.com/static/img/f000c8ee64ae569f08680c495ddb1b7b/image.png)
## コンソールの設定説明
### 設定ステップ
1. [COSコンソール](https://console.cloud.tencent.com/cos5/index)にログインして、左側のメニューバー【バケットリスト】に入り、ホットリンク保護を設定する必要があるバケットを選択して、バケットに入ります。
2. バケットの詳細ページで、【基本構成】をクリックし、ホットリンク保護設定を見つけ、【編集】ボタンをクリックして編集可能状態に入ります。
![ホットリンク保護設定1](//mc.qcloudimg.com/static/img/3d76b7e130d8917a41c4b2b7e8b1a730/image.png)
3. 現在の状態が有効であることを確認し、リストのタイプ（ブラックリストまたはホワイトリスト）を選択し、対応するドメイン名を設定し、設定が完了した後に【保存】をクリックします。ユーザーはホットリンク保護の状態を有効に設定した後、対応するドメイン名を入力する必要があります。
![referer_3](//mc.qcloudimg.com/static/img/14919513b487b1bac4a6617618e6de78/image.png)

### 規則の設定説明
-  リストタイプはブラックリスト、ホワイトリストの二者択一です：
    * ブラックリスト：バケットのデフォルトアクセスアドレスにアクセスするリスト内のドメイン名を制限し、リスト内のドメイン名がバケットのデフォルトアクセスアドレスにアクセスする場合は403を返します。
    * ホワイトリスト：バケットのデフォルトアクセスアドレスにアクセスするリスト外のドメイン名を制限し、リスト外のドメイン名がバケットのデフォルトアクセスアドレスにアクセスする場合は403を返します。
- 規則の構成例
    * ポート付きドメイン名とIPをサポートし、例えば、`test.com:8080`、`10.10.10.10:8080`などのアドレスです。
    * `test.com`を構成し、`test.com`をプレフィックスとする` test.com / 123`、 `test.com.cn`などのアドレスにヒットできます。
    * `test.com`を構成し、`https://test.com`と`http://test.com`などをプレフィックスとするアドレスにヒットできます。
    * `test.com`を構成し、そのポート付きドメイン名`test.com:8080`にヒットできます。
    * `test.com:8080`を構成し、ドメイン名`test.com`にヒットしません。
    * `*.test.com`を構成し、そのセカンドレベルドメイン名、サードレベルドメイン名`test.com`、`b.test.com`、`a.b.test.com`を制限できます。
- 最大10個のドメイン名をサポートし、かつプレフィックスが一致するようにドメイン名を設定します；ドメイン名、IPおよびワイルドカード`*`などの形式のアドレスをサポートします；1アドレスは1行であり、複数のアドレスは改行してください。

## 設定例
上述した[ホットリンクケース](#ホットリンクケース)を使用して例を挙げ、ユーザーAがどのようにしてホットリンク保護設定によりユーザーBが画像をホットリンクすることを防止することを説明します：
1. ユーザーAがバケットtestにホットリンク保護規則を設定し、`b.com`のホットリンクを防止できる方式が2つあり、実際の状況に応じて選択することができます：
 - 有効化方式1：ブラックリストモードを構成し、ドメイン名の設定に`*.b.com`を入力し、保存して有効にします。

 - 有効化方式2：ホワイトリストモードを構成し、ドメイン名の設定に`*.a.com`を入力し、保存して有効にします。
2. ホットリンク保護の構成を有効化した後：
 - `http://a.com/a.html` にアクセスして画像が正常に表示されます。

 - `http://b.com/b.html` にアクセスして画像が表示できず、表現は以下の図に示すとおりです。
![referer_4](//mc.qcloudimg.com/static/img/e58fab402a31ccc903ee3941dbb08eee/image.png)

## FAQ
バケットはCDNアクセラレーションを開き、かつCDNドメイン名を使用してリソースにアクセスし、ホットリンク保護の構成は有効になりませんか？
> ドメイン名がCDNドメイン名であるため、CDNがキャッシュされ、表現が不安定になり、[CDNコンソール](https://console.cloud.tencent.com/cdn)でホットリンク保護を構成する必要があります。

ホワイトリストであればアクセスを許可し、かつブラウザでリンクを個別に開いてもアクセスを許可するように設定できますか？
> ブラウザでリンクを個別に開く時、Refererは空であり、Refererの追加構成は現在サポートされません。

バケットtestのホットリンク保護のホワイトリストを設定し、`a.com`のアクセスを許可しますが、`a.com`におけるWebプレーヤーはバケットtestにおけるビデオファイルを再生できませんか？
> WebページでWindows Media Player、Flash Playerなどのプレーヤーを使用してビデオリンクを再生する時、リクエスト内のRefererが空であることで、ホワイトリストにヒットせず、Refererが空の時にも正常にアクセスできるには、ブラックリストモードに変更して構成することをお勧めします。
