[//]: # (chinagitpath:XXXXX)

## Device Shadow Topic

Device shadow acts like a medium, allowing device and your application to check and update device status. Communication among the device, application and device shadow is achieved through two special topics:

**`$shadow/operation/${productId}/${deviceName}`**
`Used to publish (uplink) messages, which can implement the get/update operations on device shadow data. `



**`$shadow/operation/result/${productId}/${deviceName}`**
`Used to subscribe to (downlink) messages; the shadow server sends responses and push messages through this topic. `


>**Note:**
>The above toipcs are created by system default at the time of device creation and will be automatically subscribed to by device-side SDK.

![](http://qzonestyle.gtimg.cn/qzone/vas/opensns/res/doc/3CB82138-8971-4A14-B26F-778E7DD970C2.png)



## For the Device to Get Shadow Status

If the device wants to get the latest status of the device shadow, it needs to publish a get message to the ```$shadow/operation/${productId}/${deviceName}``` topic. The SDK provides an API that sends the get message in a specific JSON string format:

```
{
    "type":"get",
    "clientToken":clientToken 
} 
```

**clientToken is the token used to uniquely identify the session, which is generated by the requester and returned as is by the responder.**

For example, the air conditioner device can send a get message to ```$shadow/operation/ABC1234567/AirConditioner``` through the API provided by the SDK to get the latest device parameters.

The device shadow server responds by sending a message to the ```$shadow/operation/result/${productId}/${deviceName}``` topic, returning all data content of the device shadow through the JSON data, and the SDK will notify the business layer through the corresponding callback function.

For example, the shadow server responds to the air conditioner device's get request by sending the following data to ```$shadow/operation/result/ABC1234567/AirConditioner```.

```
{
    "type":"get",
    "result":0,
    "timestamp"：1514967088，
    "clientToken":clientToken,
    "payload":{
        "state":{
            "reported":{
                "temperature":27,
            },
            "desired":{
                "temperature":25,
            },
            "delta":{
                "temperature":25,
            }
        },
        "metadata":{
            "reported":{
                "temperature":{
                    "timestamp":1514967066 
                },
            },
            "desired":{
                "temperature":{
                    "timestamp":1514967076
                },
            },
            "delta":{
                "temperature":{
                    "timestamp":1514967076
                },
            }
        },
        "version":1,
        "timestamp":1514967076
    }
}
```

If there is a "desired" part in the device shadow document, the device shadow service will automatically generate the corresponding "delta" part. If there is no "desired" part, no content will be present in the "desired" and "delta" parts.
>**Note:**
>The device shadow service ***does not store*** the delta messages.

## For the Device to Update the Shadow

The device tells the device shadow server its current status by sending an update message to the ```$shadow/operation/${productId}/${deviceName}``` topic. The SDK provides a corresponding API to send update messages, and the business layer only needs to specify the content of the "reported" field. The message content is in a specific JSON string format.

For example, the air conditioner device sends an update message to ```$shadow/operation/ABC1234567/AirConditioner``` to report its current device status.

```
{
	"type":"update",
	"state":{
		"reported":{
			"temperature":27
		}
	}
	"version":1,
 	"clientToken":clientToken
}
```
When the device shadow server receives this message, it first determines whether the version in the message matches the version already stored. If so, the device shadow server updates the shadow.

For example, the shadow server responds to the air conditioner device with a message:

```
{
	"type":"update",
	"result":0,
	"timestamp":1514967066,
 	"clientToken":clientToken,
	"payload":{
		"state":{
			"reported":{
				"temperature":27,
			},		
		},
		"metadata":{
			"reported":{
				"temperature":{
					"timestamp":1514967066
				},
			},
		},
		"version":2,
		"timestamp":1514967066
	}
}
```

If the version in the message does not match the version on the device shadow server, the device shadow service will respond by sending the following message to ```$shadow/operation/result/ABC1234567/AirConditioner```.

```
{
	"type":"update",
	"result":5005,
	"timestamp":1514967066,
 	"clientToken":clientToken,
	"payload":{
		"state":{
			"reported":{
				"temperature":27,
				"mode":"cool",
			},		
		},
		"metadata":{
			"reported":{
				"temperature":{
					"timestamp":1514967066
				},
				"mode":{
					"timestamp":1514967050
				}
			},
		},
		"version":2,
		"timestamp":1514967066
	}
}
```

At this point, the full content of the device shadow document will be returned in the payload.

## For the Application to Update the Shadow

The application modifies the device shadow's "desired" field via the HTTP RESTful API.

For example, it can modify the air conditioner's operating parameters via the HTTP RESTful API.

```
{
	"type":"update",
	"state":{
		"desired":{
			"temperature":25
		}
	}
	"version":2,
	"clientToken":clientToken
}
```
When the device shadow server receives this message, it first determines whether the version in the message matches the version stored on it. If yes, the device shadow update process will be performed and the application is responded to with a JSON message via the HTTP RESTful API.

```
{
	"type":"update",
	"result":0,
	"timestamp":1514967076,
	"clientToken":clientToken,
	"payload":{
		"state":{
			"desired":{
				"temperature":25
			},
		},
		"metadata":{
			"desired":{
				"temperature":{
					"timestamp":1514967076 
				},
			},
		},
		"version":3,
		"timestamp":1514967076
	}
}
```

In addition, the shadow server sends a delta message to ```$shadow/operation/result/ABC1234567/AirConditioner```.

```
{
	"type":"delta",
	"timestamp":1514967076,
	"payload":{
		"state":{
			"temperature":25
		},
		"metadata":{
			"temperature":{
				"timestamp":1514967076
			},
		},
		"version":3,
		"timestamp":1514967076
	}
}

```

The SDK notifies the business layer that the message has been received through the corresponding callback function.


## For the Device to Respond to "Delta" Message

After the device receives the delta message, the business layer can empty the content of the "desired" field and send it to the device shadow server, indicating that the device has ***responded to*** this delta message by sending a message to the ```$shadow/operation/${productId}/${deviceName}``` topic.

For example, after the air conditioner adjusts the temperature, a message is sent to ```$shadow/operation/ABC1234567/AirConditioner```:

```
{
    "type":"update",
    "state":{
        "desired":null
    }
    "version":3,
    "clientToken":clientToken 
}
```
The SDK provides a corresponding API to send the message above. When the device shadow server receives this message, it clears the content of the "desired" field to prevent repeated sending due to the differences between the parameter value in the "reported" field and that in the "desired" field.

After receiving the message, the shadow server sends a response message to ```$shadow/operation/result/${productId}/${deviceName}```.

For example, after receiving the ```"desired":null``` message from the air conditioner, the shadow server sends a device shadow update success message to ```$shadow/operation/result/ABC1234567/AirConditioner```.

```
{
	"type":"update",
	"result":0,
	"timestamp":1514967086,
 	"clientToken":clientToken,
	"payload":{
		"state":{
			"reported":{
				"temperature":25,
			},		
			"desired":null,
		},
		"metadata":{
			"reported":{
				"temperature":{
					"timestamp":1514967086
				},
			},
			"desired":{
				"temperature":{
					"timestamp":1514967086
				},
			}
		},
		"version":4,
		"timestamp":1514967086
	}
}
```

If some parameter fields in the "reported" part of the device are null, the corresponding fields in the device shadow will be deleted. When update succeeds, the fields in the returned payload contain only the content related to the updated fields.

If the version value carried during the device update is smaller than that saved on the server, the data on the device is old. The server will send a failed to update message, and the error code (the "result" field) will indicate to SDK the reason as version being too low. The latest content will be sent to the device in the payload.

