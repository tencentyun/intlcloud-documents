## 응용 시나리오
### 그룹 내 메시지 수발신
그룹 구성원이 그룹 내에서 메시지를 수발신하는 방식은 QQ 그룹, WeChat 그룹 채팅과 유사합니다. 

### App 관리자 메시지 발송
App 관리자는 백엔드에서 그룹 채팅 메시지를 발송할 수 있고, 다른 사용자 신분으로 메시지를 보낼 수도 있습니다(App 관리자 또는 발신자가 그룹 구성원이 아니어도 메시지 발송 가능).

### App 관리자 시스템 메시지 시뮬레이션
App 관리자는 백엔드에서 메시지 발송을 통해 시스템 메시지 형식으로 그룹 내 온라인 구성원에게 알림 메시지를 보내는 것을 시뮬레이션할 수 있습니다. App은 App 관리자의 사용자 정의 메시지를 받으면 특수 처리 합니다.

## 그룹 메시지의 SEQ 메커니즘
IM은 모든 그룹에 대해 하나의 메시지 SEQ를 관리합니다. SEQ의 초기값은 1이며 그룹 내에서 일반 메시지 한 건이 발생하면 IM 백엔드는 현재 SEQ 값을 해당 메시지의 SEQ로 설정하고 현재 SEQ에 1을 더합니다.
그룹 ID와 SEQ는 함께 메시지의 고유 식별자를 구성합니다.

>!IM은 로밍 저장의 대상이 되는 메시지에 대해서만 증분 SEQ를 생성합니다.



### 그룹 채팅 메시지 유형

| 메시지 유형     | 설명                                                     |
| ------------ | ------------------------------------------------------------ |
| 텍스트 메시지     | 일반 텍스트로 구성된 메시지                                           |
| 이미지 메시지     | 이미지 URL 주소, 사이즈, 이미지 크기 등의 정보로 구성된 메시지               |
| 이모티콘 메시지     | 개발자 사용자 정의 이모티콘 메시지                                       |
| 음성 메시지     | 음성 데이터는 초 단위의 길이 정보 제공 필요                         |
| 지리적 위치 메시지 | 지리적 위치명, 경도, 위도 정보로 구성된 메시지                      |
| 파일 메시지     | 파일의 URL 주소, 크기, 형식 등 정보로 구성된 메시지. 형식 제한 없으며 최대 100M 지원|
| 쇼트 비디오 메시지   | 쇼트 비디오 파일의 URL 주소, 길이, 크기, 형식 등 정보로 구성된 메시지. 최대 100M 지원|
| 사용자 정의 메시지   | 홍바오 메시지, 가위바위보 등과 같은 개발자 사용자 정의 메시지 |
| 시스템 알림 메시지 | 내부 시스템 알림 메시지 및 개발자 사용자 정의 시스템 알림 메시지 포함             |


### 그룹 채팅 메시지 기능

|  유형             | 기능 설명                                                     | 응용 시나리오                                                   |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 그룹 일반 메시지 발송         | 그룹 구성원은 IM SDK 인터페이스를 통해 메시지 발송 가능. App 관리자는 그룹에 가입하지 않고 바로 REST API 호출하여 모든 그룹에 메시지 발송 가능. | 그룹 구성원의 그룹 내 메시지 발송. App 관리자의 임의 그룹에 메시지 발송.            |
| 그룹 시스템 메시지 발송           | App 관리자는 그룹에 가입하지 않고 바로 REST API를 호출하여 그룹에 시스템 알림 발송 가능. 시스템 알림은 온라인 상태인 그룹 구성원만 수신 가능하며, 로밍 기능은 없음. | App 관리자가 그룹의 일부 또는 전체 온라인 구성원에게 긴급 알림 발송   |
| 그룹 메시지 오프라인 푸시          |  Apple, Huawei, Xiaomi, OPPO, Vivo, Meizu 등 휴대폰 오프라인 푸시 지원 | 그룹 채팅 메시지 오프라인 푸시                                            |
| 그룹 온라인 메시지 수신         | 그룹 구성원은 IM SDK를 통해 그룹 채팅 온라인 메시지 수신 가능.                      | 온라인 상태인 그룹 구성원 그룹 메시지 실시간 수신                                      |
| 그룹 구성원 오프라인/메시지 기록 가져오기  | 그룹 구성원은 IM SDK 인터페이스로 메시지 기록 쿼리 가능.                | 그룹 구성원이 온라인 상태일 때 오프라인 메시지 수신. 그룹 채팅 기록 확인                 |
| App 백엔드 그룹 메시지 가져오기       | App 관리자는 REST API로 일정 시간 동안 App에서 발생한 모든 메시지 다운로드 및 모든 그룹 채팅 기록 가져오기 가능. App 백엔드는 그룹 내 발언 후 콜백을 통해 그룹 메시지를 실시간 가져오기 가능.  | App의 메시지 기록 주기적 백업, 특정 그룹 메시지 기록 신속하게 가져오기, 그룹 메시지 실시간 수신.  |
| 메시지 삭제                 |  REST API를 통해 메시지 기록 삭제하여 해당 메시지 전파 방지 가능.              | 그룹 내 악성 정보 삭제                                             |
| 그룹 채팅 메시지에 발신자 프로필 정보 포함 | 그룹 메시지에 발신자의 닉네임, 프로필 사진, 그룹 명함, 사용자 차원의 사용자 정의 필드, 그룹 구성원 차원의 사용자 정의 필드 표시. | 메시지 발신자 닉네임, 프로필 사진 등 정보 표시                              |
| 비속어 필터               | IM 백엔드가 사용자가 발송한 메시지에서 비속어를 감지하면, 해당 메시지 발송을 거부하고 발신자에게 에러 코드 80001을 반환함. <br/>비속어 필터링 니즈 충족을 위해 IM에는 정치, 선정적 언어 등이 비속어로 기본 설정되어 있으며, App 사용자 정의 욕설 필터링 지원. | 메시지 콘텐츠 필터링                                                |
| 그룹 메시지 발송 제어          | 음소거와 그룹 메시지 발송 전 콜백을 통한 그룹 메시지 발송 제어. | 그룹에서 특정 구성원의 메시지 발송 금지. 모든 구성원의 메시지 발송 금지. App 백엔드에서 메시지 필터링 또는 수정 |
| 그룹 메시지 메시지 수신 제어          | 개별 그룹에 다양한 메시지 수신 옵션 설정 가능: 수신 및 알림, 알림 없이 수신, 메시지 차단. ‘알림 없이 수신’ 설정 시 iOS 디바이스는 APNs 푸시 기능을 취소함. | 사용자의 특정 그룹 메시지 차단                                       |
| 그룹 메시지 빈도 제어          |  그룹 일반 메시지 발송 빈도를 제어(기본값: 40건/초). App 관리자가 REST API를 통해 발송한 그룹 시스템 메시지는 해당 없음(상세 내용은 아래의 메시지 우선순위 및 빈도 제어 참고) | 스팸 메시지 방지                                                 |


>! 발신자 닉네임 및 프로필 사진을 포함하려면, 이 2개 필드 정보를 IM 사용자 프로필 정보로 가져오기해야 합니다.
>사용자 정의 프로필 정보를 포함하려면, 우선 콘솔에서 사용자 정의 필드를 설정하고 티켓을 제출하여 메시지에 포함될 관련 필드를 신청하십시오.



## 그룹 메시지 발송 제어

다음과 같은 방법으로 그룹 메시지 발송을 제어할 수 있습니다. 

|  제어 방식       | 상세 설명                                                     |
| ---------------- | ------------------------------------------------------------ |
| 그룹 내 음소거       | 일정 시간 동안 특정 사용자의 그룹 내 발언을 금지하며, 단일 그룹에만 적용 가능합니다. 음소거 시간 만료 전에는 사용자 퇴장 후 재입장 시에도 계속 적용됩니다.  |
| 그룹 메시지 발송 전 콜백 | 그룹 메시지를 구성원에게 발송하기 전에 IM 백엔드는 우선 App 백엔드에 메시지 발송 허용 여부를 문의합니다. 허용하지 않으면 메시지 발송은 거부됩니다. <br>App 백엔드는 콜백을 수신한 후, 메시지 콘텐츠를 수정하고 IM에게 반환할 수 있으며, IM은 수정된 메시지를 발송합니다. 자세한 내용은 [그룹 내 발언 전 콜백](https://intl.cloud.tencent.com/document/product/1047/34374)을 참고하십시오. <br> 콜백 요청 후, IM은 재시도 없이 최대 2초 내에 응답을 받지 못하면 메시지를 바로 그룹 구성원에게 발송합니다. |


## 메시지 우선 순위 및 빈도 제어
### 그룹 메시지 우선 순위

그룹 메시지 우선 순위는 3가지로 나뉩니다. 그룹 메시지가 빈도 제한을 초과하면 백엔드는 우선 순위가 높은 메시지를 먼저 발송합니다. 그렇기 때문에 사용자는 메시지 중요도를 고려하여 적합한 우선순위를 선택해야 합니다. 
다음은 3가지 우선 순위를 높음에서 낮음 순으로 나열한 것입니다.

| 우선순위 | 권장 메시지 유형 |
| ------ | -------------------------- |
| High   | 홍바오 메시지 및 선물 메시지         |
| Normal | 일반 텍스트 메시지               |
| Low    | 좋아요 메시지                   |

### 그룹 메시지 빈도 제어

#### 수량 기준 메시지 빈도 제어

>? 수량 기준 메시지 빈도 제어는 단일 그룹이 초당 발송할 수 있는 최대 메시지 수에 대한 제한으로, 기본값은 40건/초이며, 초당 평균값을 기준으로 합니다. 메시지 수가 제한을 초과하면 백엔드는 우선순위가 상대적으로 높은 메시지를 먼저 발송하고 우선 순위가 동일한 메시지는 랜덤으로 전달합니다. 

빈도 제어에 의해 제한된 메시지는 메시지 기록에 저장되지 않지만, 발신자에게 발송 성공이 반환될 수 있습니다. 이 때, [그룹 내 발언 전 콜백](https://intl.cloud.tencent.com/document/product/1047/34374)이 트리거되지만 [그룹 내 발언 후 콜백](https://intl.cloud.tencent.com/document/product/1047/34375)은 트리거되지 않습니다.

#### 우선순위 기준 빈도 제어

우선순위 기준 빈도 제어는 단일 그룹이 초당 발송할 수 있는 특정 우선 순위의 최대 메시지 수량을 제한합니다. 메세지 발송 요청은 우선순위 기준 빈도 제어 전 먼저 수량 기준 메시지 빈도 제어를 통과해야 합니다.

모든 메시지는 초당 40건의 빈도 제한이 적용되며, 3가지 우선순위를 설정할 수 있습니다. High 우선순위 메시지는 우선순위 제한을 받지 않지만, 초당 메시지 수량이 40건을 초과하면 폐기됩니다.


## 그룹 오프라인 메시지 프로세스
![](https://main.qcloudimg.com/raw/3cffbd86ff1fda0a28221c7700d1718f.png)

#### 그룹 오프라인 메시지 프로세스는 다음과 같습니다.
1. 사용자 A가 `sendMessage`를 호출하여 그룹 C에 메시지를 발송합니다. 이때, 사용자 B는 오프라인 상태입니다.
    1.1 그룹 C는 사용자 B의 최근 대화 상대에 추가되며 최대 100개의 메시지가 캐시됩니다.
    1.2 사용자가 그룹 최신 메시지 seq를 포함한 그룹 메시지 정보를 업데이트합니다.
    1.3 메시지는 7일 동안 로밍 서버에 저장됩니다.
2. 사용자 B가 `login` 인터페이스를 호출하여 IM에 로그인합니다. 
3. SDK는 최신 메시지 seq 및 읽지 않은 메시지 수를 포함한 모든 그룹 메시지 seq 정보를 자동으로 가져옵니다.
4. SDK는 최근 대화 상대를 자동으로 가져오기하고 OnNewMessage API를 통해 출력합니다.
5. 메시지 동기화 과정이 끝나면 `OnRefresh` 인터페이스를 통해 사용자에게 데이터 동기화가 완료되었음을 알려줍니다.
6. 사용자가 `getMessage`를 호출하면 SDK가 로밍 서버를 자동으로 풀링합니다.


