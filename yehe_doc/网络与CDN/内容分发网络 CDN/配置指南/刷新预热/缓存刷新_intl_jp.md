## 機能概要

Content Delivery Network（CDN）は基本的なキャッシュ構成機能を提供しています。サービスタイプやディレクトリ、具体的なURL等各種のルールにより、キャッシュ期限切れ期間を設定することにより、定期的にノードのキャッシュリソースをクリアし、オリジンサーバーが最新のリソースを再度プルしキャッシュする目的を果たします。

また、CDNはキャッシュ更新機能を提供しています。URLまたはディレクトリを一括指定して更新操作を行うことができます。

- URLの更新：CDNのすべてのノードにおける対応するリソースのキャッシュを削除します。
- ディレクトリの更新：「変更されたリソースの更新」モードを選択すると、ユーザーがマッチングしているディレクトリ配下のリソースにアクセスする時に、back-to-originを行ってリソースのLast-Modify情報を取得します。現在のキャッシュリソースと一致している場合、直接キャッシュされたリソースを返しますが、一致しない場合は、back-to-originを行って新しいリソースをプルし、再度キャッシュします。「すべてのリソースの更新」モードを選択すると、ユーザーがマッチングしているディレクトリ配下のリソースにアクセスする時に、直接back-to- originを行って新しいリソースをプルしてユーザーに返し、再度これをキャッシュします。

> ?更新が正常に実行された後は、ノード上に対応するリソースの有効なキャッシュは存在しません。ユーザーがアクセスを再開すると、ノードはオリジンサーバーに戻り、必要なリソースをプルし、ノードに再度キャッシュします。以上より、大量の更新タスクを送信すると、より多くのキャッシュがクリアされ、その結果、back-to-originリクエストが突発的に増加し、オリジンサーバーに大きな負荷がかかります。

## 適用ケース

### 新しいリソースのリリース

古いリソースがオリジンサーバー上で同じ名前の新しいリソースによって上書きされた場合、ネットワーク全体のユーザーがノードのキャッシュの影響を受け、古いリソースにアクセスしてしまうことを避けるために、対応するリソースのURL / ディレクトリをサブミットして更新し、ネットワーク全体のキャッシュをクリアにします。これにより、 ネットワーク全体のユーザーがリソースの最新バージョンに直接アクセスすることが可能となります。

### 不正なリソースの削除

オリジンサーバーに不正なリソース（ポルノ、薬物、ギャンブル関係など）が見つかった場合、オリジンサーバーでそれらを削除しても、ノードにキャッシュがあるため、アクセスが可能となります。ネットワーク環境を守るために、URLの更新によってキャッシュされたリソースを削除すれば、不正なリソースのタイムリーな削除を保証できます。

## 操作ガイド

### 利用方法

[CDNコンソール](https://console.cloud.tencent.com/cdn)にログインし、左側のディレクトリの【パージとプリフェッチ】をクリックし、ページに入ってから必要に応じて【URL更新】および【ディレクトリ更新】をサブミットします。CDNとECDNのURL/ディレクトリは、混合入力とサブミットをサポートしています。
![](https://main.qcloudimg.com/raw/a3442259ffa50bccb60dabf002ea6dfb.png)
![](https://main.qcloudimg.com/raw/d4b01354bab726ea890e8167ccdbaffe.png)
>? urlencodeの機能を有効にすると，URL更新とディレクトリ更新によって、中国語のテキストに対し、自動的にエンコードの変換が行われます。

<span ID = "notes"></span>
【操作履歴】で、期間、キーワード、更新タスクのタイプを指定してクエリーできます。キーワードはドメイン名の指定によるクエリー、または完全なURL/ディレクトリ更新の指定によるクエリーのみをサポートしています。
![](https://main.qcloudimg.com/raw/86e00c9652a635cf0a0007172119be92.png)

> ? コンソールは一度に最大10000件の操作レコードを返すことができ、完全なExcel形式にエクスポートできます。更新タスクが多い場合は、分けてクエリーして一括エクスポートを行ってください。

### 注意事項

**URLの更新**：

- 各アカウントの1日あたりのURL更新の上限は10,000個で、毎回サブミットできるURL更新の上限は1,000個です。中国本土以外でアクセラレーションをアクティブ化している顧客については、海外での1日あたりのURL更新の上限は10,000個で、中国本土のクォータの制限を受けません。
	
	>? URL更新量が多く、URL更新の1日の割り当ての残りが少ない（1000未満など）場合、Tencent Cloud CDNは、コンソールによる1日の割り当ての自動ワンクリック追加をサポートします（50,000個に追加するなど）。
>- 割り当ての追加はすぐに有効になりますので、その時点でページを更新し、追加ボタンを頻繁にクリックしないでください。
>- 1度のみの追加をサポートします。例えば、今回、1日の割り当てを50,000まで追加した場合、残りの割り当てが少なくなっても、50,000を超える割り当ての追加はサポートされません。
>- 異なるリージョンでの割り当ての追加は、相互に独立し制限を受けません。
- 更新タスクをサブミットする際に、`http://`または`https://`プロトコル識別子を付け加える必要があります。
- `http://*.test.com/`形式のURLは更新できません。ワイルドカードドメイン名が接続されてアクセラレーションサービスを行っても、更新する際に対応するサブドメイン名をサブミットする必要があります。
- 更新をサブミットする際に、URL中のドメイン名はアクセラレーション サービスに接続する必要があります。そうしないと、サブミットが失敗することがあります。
- デフォルトでは、URL更新のタスクをサブミットする際に、URL中のドメイン名アクセラレーション対象地域は地域全体で更新されます。

**ディレクトリの更新**：

- 各アカウントの1日あたりのディレクトリ更新の上限は100個で、毎回サブミットできるディレクトリ更新の上限は20個です。中国本土以外でアクセラレーションをアクティブ化している顧客については、海外での1日あたりのURL更新の上限は100個で、中国本土のクォータの制限を受けません。
- 更新タスクをサブミットする際に、`http://`または`https://`プロトコル識別子を付け加える必要があります。
- `http://*.test.com/`形式のディレクトリの更新をサポートしていません。ワイルドカードドメイン名が接続されてアクセラレーション サービスを行っても、更新する際に対応するサブドメイン名をサブミットする必要があります。
- 更新をサブミットする際に、URL中のドメイン名はアクセラレーション サービスに接続する必要があります。そうしないと、サブミットが失敗することがあります。

**サブユーザー権限の設定**：

- ディレクトリの更新、URLの更新、更新記録のクエリーは、現在すでに最新の権限システムに接続され、リソース（ドメイン名）次元の権限設定をサポートしています。
- アサイン方法は [権限設定](https://intl.cloud.tencent.com/document/product/228/35229)をご参照ください。

## 利用事例

### ディレクトリ更新-変更されたリソースを更新する

アクセラレーションドメイン名がpurge-test-1251991073.file.myqcloud.comであり、オリジンサーバーがTencent CloudのCloud Object Storage（COS）です。オリジンサーバーのリソースは下記のとおりです。
![](https://main.qcloudimg.com/raw/ed694acc98a8d3114c8a9922f7374a1b.png)

1. それぞれリソース1.txt と2.txtのアクセスリクエストを送信し、X-Cache-Lookup: Hit From Distank3およびServer: NWS_SPMid により、ヒットしたノードを判定することができます。ノードより直接リソースを返します。
   ![](https://main.qcloudimg.com/raw/9b307b80e7d1c759bb073eb9f2cf4b6c.png)
   ![](https://main.qcloudimg.com/raw/5fed8bff43d699f47235e5d0db1f2447.png)
2. オリジンサーバーで同名ファイルの1.txtを差し替え、ファイル修正時間が変更されます。2.txtはそのままにします。
   ![](https://main.qcloudimg.com/raw/798fd6a984813aa3a16eaf43856ff7c2.png)
   ![](https://main.qcloudimg.com/raw/bc0d40200fbc744ed34d8552a95c5671.png)
3. この際に、再度リクエストを送信します。キャッシュはまだ期限切れになっていないため、リソース1.txtへのアクセスが古い内容のままです。
   ![](https://main.qcloudimg.com/raw/b5769a3d7fddaeadfda229115ac59bb8.png)
4. ディレクトリ更新をサブミットし、【変更されたリソースを更新する】を選択し、更新が完了するまで待ちます。
   ![](https://main.qcloudimg.com/raw/31346a963f189187852dde17a4bf0309.png)
5. 更新した後に、ファイル1.txt Last-Modifiedに変更があったため、リクエストはオリジンサーバーに直接転送されます。ファイル2.txtは変更がなかったため、ディレクトリ更新タスクがサブミットされた後でも、ヒットして返されます。
   ![](https://main.qcloudimg.com/raw/0ea8c1e0e7caac970b3875d4b3987687.png)
   ![](https://main.qcloudimg.com/raw/84e599b1c9c655e62497fb4bdc8e7918.png)
