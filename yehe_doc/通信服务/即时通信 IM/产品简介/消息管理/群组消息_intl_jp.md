## ユースケース
### グループ内のメッセージ受送信
グループメンバーがグループ内でメッセージを受送信することは、QQグループ、WeChatグループのチャット方式と類似します。

### App管理者がメッセージを送信する
グループチャットメッセージは、App管理者がバックグラウンドからメッセージを送信するか、他のユーザをシミュレートしてメッセージを送信することができます（App管理者または送信者がグループメンバーでなくてもメッセージは送信されます）。

### App管理者がシステムメッセージをシミュレートする
App管理者がバックグラウンドでメッセージを送信することにより、システムメッセージをシミュレートし、システムメッセージで指定のグループ内のオンラインメンバーに送信することができ、App側はApp管理者のカスタムメッセージを受信して特殊処理を行うことができます。

## グループメッセージのSEQメカニズム
インスタントメッセージIMは、グループごとにメッセージSEQを保持します。SEQの初期値は1です。グループ内で一般メッセージが1件生成されると、インスタントメッセージIMバックグラウンドは、現在のSEQの値をこのメッセージのSEQとして使用し、このSEQを1増やします。
グループID+SEQは、メッセージの一意のIDに相当します。

>!インスタントメッセージIMは、ローミングされたメッセージにのみ増分SEQを生成します。



### グループチャットメッセージのタイプ

| メッセージタイプ     | 説明                                                     |
| ------------ | ------------------------------------------------------------ |
| テキストメッセージ     | メッセージ内容は通常のテキスト                                           |
| 画像メッセージ     | メッセージの内容は、画像のURLアドレス、サイズ、画像の大きさなどの情報を含む                |
| 絵文字メッセージ     | 絵文字メッセージは開発者がカスタマイズしたもの                                       |
| 音声メッセージ     | 音声データには、秒単位の時間情報が必要                         |
| 地理位置メッセージ | メッセージ内容は地理位置の表題、経度、緯度情報                       |
| ファイルメッセージ     | メッセージ内容はファイルのURLアドレス、サイズ、形式などを含み、形式を問わず、最大100MBをサポートする |
| ショート動画メッセージ   | メッセージ内容はショート動画ファイルのURLアドレス、時間、サイズ、形式などを含み、最大100MBをサポートする |
| カスタムメッセージ   | 開発者が定義したメッセージのタイプ、例えば、ラッキーマネーメッセージ、じゃんけんなどの形式のメッセージ |
| システム通知メッセージ | 組み込みのシステム通知メッセージと開発者のカスタマイズしたシステム通知メッセージ             |


## グループチャットメッセージ能力

| タイプ             | 機能説明                                                     | ユースケース                                                     |
| ------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| グループの一般メッセージを送信する           | グループメンバーは、IM SDKインターフェースを介してメッセージを送信することができる。App管理者は、グループに参加せずにREST APIを呼び出して任意のグループ内でメッセージを送信することができる。| グループメンバーはグループ内でメッセージを送信し、App管理者は任意のグループにメッセージを送信する            |
| グループシステムメッセージを送信する           | App管理者は、グループに参加せずにREST APIを呼び出してグループ内でシステム通知を送信することができる。このシステム通知は、グループ内のオンラインメンバーのみがこのメッセージを受信し、ローミング機能を備えない。| App管理者がグループ内のオンラインメンバーの一部または全員に時効性の高いリマインダ通知をプッシュする    |
| グループメッセージのオフラインプッシュ         | Apple、Huawei、Xiaomi、OPPO、vivoおよびMEIZUなどの携帯電話のオフラインプッシュをサポートする | グループチャットメッセージのオフラインプッシュ                                             |
| グループのオンラインメッセージを受信する           | グループメンバーはIM SDKを介してグループチャットのオンラインメッセージを受信することができる                          | オンラインのグループメンバーはリアルタイムにグループメッセージを受信する                                     |
| グループメンバーがオフライン/履歴メッセージを取得する  | グループメンバーがIM SDKインターフェースを介して履歴メッセージを照合する                              | グループメンバーがオフラインメッセージをオンラインで受信し、グループメンバーがグループチャットの記録を閲覧する                 |
| Appバックグラウンドでグループメッセージを取得する        | App管理者は、REST APIを介してAppの一定期間内に生成したすべてのメッセージをダウンロードすることができる。App管理者は、REST APIを使用して、任意のグループのチャット記録を取得することもできます。Appのバックグラウンドは、グループ内発言後のコールバックにより、リアルタイムにグループメッセージを取得することができる。| Appがメッセージ記録を定期的にバックアップするシナリオ。Appが指定されたグループの履歴メッセージを迅速に取得しなければならないシナリオ。Appがリアルタイムでグループメッセージを取得しなければならないシナリオ |
| メッセージを削除する                 | REST APIを使用して履歴メッセージを削除して、このメッセージが伝播されないようにする             | グループ内の悪意のある情報を削除する                                             |
| グループチャットメッセージに送信者情報を含める | グループメッセージに送信者のニックネーム、プロファイル画像、グループ名刺、ユーザ次元のカスタムフィールド、グループ次元のカスタムフィールド、グループメンバー次元のカスタムフィールドを含める | メッセージ送信者のニックネーム、プロファイル画像などの情報を表示する                               |
| ダーティワードのフィルタリング                 | インスタントメッセージIMはバックグラウンドで、ユーザが送信したメッセージにダーティワードが含まれているか否かを検出する。含まれている場合、メッセージの送信を拒否し、エラーコード80001を送信者に返す。<br/>インスタントメッセージIMには、政治、ポルノに関わるダーティワードがデフォルトで構成されており、この2つの方面のフィルタリング要求の大部分を満たすことができる。また、Appでダーティワードを構成することもサポートされる。| メッセージのセキュリティ攻撃                                                 |
| グループメッセージの送信管理           | 発言禁止とグループメッセージ送信前のコールバックは、グループメッセージ送信を管理する2つの方式である。| グループ内の特定のメンバーからのメッセージの送信を禁止する。グループ内のすべてのメンバーからのメッセージの送信を禁止する。Appがバックグラウンドでメッセージをフィルタリングまたは変更する |
| グループメッセージの受信管理           | ユーザは、1つのグループに「受信して通知する」、「受信しても通知しない」、「メッセージをマスクする」のメッセージ受信オプションを設定する。「受信しても通知しない」を設定すると、iOS端末はAPNsプッシュ機能をオフにする | ユーザが特定のグループのメッセージをマスクする                                       |
| グループメッセージの頻度管理           | グループの一般メッセージの送信頻度を管理する。デフォルト値は40件/秒。頻度管理対象は、App管理者がREST APIを使用して送信したグループシステムメッセージを含まない。詳細については、以下のメッセージ優先度と頻度管理をご参照ください。| スパム行為を避ける                                                 |


>!送信者のニックネームとプロファイル画像を含める必要がある場合、これら2つのフィールドの情報をインスタントメッセージIMのユーザ情報にインポートしなければなりません。
>カスタム情報を含める必要がある場合、まずコンソールでカスタムフィールドを設定して、作業依頼書を提出して該当するフィールドをメッセージに追加する必要があります。



## グループメッセージの送信管理

グループメッセージの送信は次の方法で管理します。

| 管理モード         | 詳細説明                                                     |
| ---------------- | ------------------------------------------------------------ |
| グループ内発言禁言       | 特定のユーザがグループ内で一定期間内発言することを禁止する。禁止は1つのグループにのみ有効である。ユーザがグループを退会して再びグループに入った場合、発言禁止期間が満了するまで、発言禁止は有効である |
| グループメッセージ送信前のコールバック | グループメッセージをグループメンバーに送信する前に、インスタントメッセージIMはバックグラウンドでAppバックグラウンドに対して、メッセージの送信の可否を問い合わせる。許可されない場合、メッセージの送信を拒否する。<br>Appバックグラウンドは、コールバックを受信した後、メッセージの内容を修正してインスタントメッセージIMに返すこともできる。インスタントメッセージIMは修正された情報を使用して送信する。詳細については[グループ内発言前のコールバック](https://intl.cloud.tencent.com/document/product/1047/34374)をご参照ください。<br>ただし、インスタントメッセージIMはこのコールバックを開始してから最大2秒しか待たない。2秒以内に応答がない場合、再試行せずにメッセージをグループメンバーに直接送信する |


## メッセージの優先度と頻度管理
### グループメッセージの優先度

グループメッセージには4つの優先度があり、あるグループのメッセージが頻度制限を超えた場合、バックグラウンドは優先度の高いメッセージを優先的に送信します。したがって、ユーザはメッセージの重要度に応じて適切な優先度を選択する必要があります。
4つの優先度の優先順位は次の通りです。

| 優先度 | この優先度を選択することが推奨されるメッセージのタイプ |
| ------ | -------------------------- |
| High   | ラッキーマネーメッセージとプレゼントメッセージ         |
| Normal | 一般テキストメッセージ               |
| Low    | 「いいね！」メッセージ                   |
| Lowest | 最も重要でないメッセージ             |

### グループメッセージ頻度管理

#### 総メッセージ数頻度管理

総メッセージ数頻度管理は、1つのグループで1秒あたりに送信できる最大メッセージ数の制限（デフォルト値は40件/秒）です。メッセージ数が制限を超えると、バックグラウンドは相対的に優先度の高いメッセージを優先して送信し、同じ優先度のメッセージをランダムにソートします。

頻度管理によって制限されたメッセージは、送信も履歴メッセージの保存も行われませんが、送信者に成功を返します。[グループ内発言前のコールバック](https://intl.cloud.tencent.com/document/product/1047/34374)はトリガーされますが、[グループ内発言後のコールバック](https://intl.cloud.tencent.com/document/product/1047/34375)はトリガーされません。

#### 優先度の頻度管理

優先度の頻度管理は、1つのグループで特定の優先度のメッセージを1秒あたりにどのぐらい送信することです。メッセージ送信要求は、総メッセージ数の頻度管理を行った後に優先度頻度管理に入ります。

すべてのメッセージには40件/秒の頻度制限があり、3つの優先度を設定することができます。Highレベルが設定されたメッセージには最高の優先度があるため、制限されません。また、1秒内に40件/秒を超えると、高優先度メッセージも破棄されます。

SDKAppIDの各[グループタイプ](https://intl.cloud.tencent.com/document/product/1047/33529)には、独自の総メッセージ数頻度管理と優先度頻度管理の構成があります。デフォルト値を変更する必要がある場合、[作業依頼書サブミット](https://console.cloud.tencent.com/workorder/category?level1_id=29&level2_id=40&source=0&data_title=%E4%BA%91%E9%80%9A%E4%BF%A1%20%20IM&step=1)して申請してください。



## グループオフラインメッセージ処理の流れ
![](https://main.qcloudimg.com/raw/3cffbd86ff1fda0a28221c7700d1718f.png)

#### グループオフラインメッセージ処理の流れ：
1. ユーザAが`sendMessage`を呼び出してグループCにメッセージを送信し、ユーザBがオフライン状態にあります。
    1.1 グループCをユーザBの最近使用した連絡先に追加します。キャッシュは100件までです。
    1.2 ユーザがグループのメッセージ情報（グループの最新メッセージseqを含む）を更新します。
    1.3 メッセージをローミングサーバーに保存します。時間制限は7日です。
2. ユーザBは、`login`インターフェースを呼び出しインスタントメッセージIMにログインします。
3. SDKは、すべてのグループのメッセージseq情報（最新メッセージseqと未読数を含む）を自動的に取得します。
4. SDKは最近使用した連絡先を自動的に取得し、`OnNewMessage`インターフェースを介してスローします。
5. メッセージ同期が完了すると、`OnRefresh`インターフェースを介してユーザに、グループデータの同期完了を通知します。
6. ユーザが`getMessage`を呼び出すと、SDKはローミングサーバーを自動的にプルします。


