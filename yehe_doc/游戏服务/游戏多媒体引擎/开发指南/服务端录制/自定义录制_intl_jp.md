本書では、カスタムレコーディングで**GMEサーバー側のレコーディング**機能にアクセスする方法を説明します。



## 運用シーン

GMEはリアルタイム音声ストリーム向けの**サーバー側のレコーディング**機能を提供し、開発者がコンテンツの保存/管理/二次創作などのシーンを実装することに役立ちます。フルレコーディング：アプリケーションにおけるすべての音声ルームに対して、ルームによるミックスストリーミングとユーザーによるシングルストリーミングをレコーディングすることをサポートします。カスタムレコーディング：ユーザーが指定したルームに対して、ルームによるミックスストリーミングとユーザーによるシングルストリーミングをレコーディングすることをサポートします。レコーディングしたオーディオファイルは、ご利用のアカウント配下の**COS**サービスに保存されます。

本書では、**カスタムレコーディング**の開発・アクセス方法のみを説明します。アプリケーションに対して、フルレコーディングを有効にするには、[開発ガイド-フルレコーディング]()をご参照ください。

>! 
>- GMEサーバー側のレコーディング機能を使用すると、レコーディング中にGMEでレコーディングサービスの使用料金が発生します。GME国際サイトのレコーディングサービスは、2023年4月1日より正式に課金を開始いたします。詳細な料金情報については、[GME購入ガイド](https://www.tencentcloud.com/document/product/607/50009)をご参照ください。
>- レコーディングしたファイルは、ご利用のTencent Cloudアカウント配下の**COS**サービスに保存されます。**COS**請求書は、実際のストレージ使用量、保存期間、アクセス頻度などに応じて作成されます。料金情報の詳細については、[COS料金説明](https://www.tencentcloud.com/document/product/436/16871)をご参照ください。

##  前提条件

- **リアルタイム音声サービスが有効になっていること：[サービス有効化ガイド](https://www.tencentcloud.com/document/product/607/10782)をご参照ください。
- **サーバー側のレコーディングサービスが有効になっていること**：現在、サーバー側のレコーディングサービスは、ホワイトリストユーザーだけに提供しています。ホワイトリストを有効化するには、こちらに連絡してください。
- **GME SDK導入済み**：コアインターフェースとリアルタイム音声インターフェースの導入を含みます。詳細については、[Native SDKクイックスタート](https://www.tencentcloud.com/document/product/607/40858)、[Unity SDKクイックスタート](https://www.tencentcloud.com/document/product/607/44544)、[Unreal SDKクイックスタート](https://www.tencentcloud.com/document/product/607/44545)をご参照ください。


## サービスアーキテクチャ

![](https://staticintl.cloudcachetci.com/yehe/backend-news/zUFy538_PRELIM__%E6%B8%B8%E6%88%8F%E5%A4%9A%E5%AA%92%E4%BD%93%E5%BC%95%E6%93%8E_%E4%BA%A7%E5%93%81%E7%9B%AE%E5%BD%95_%E4%B8%AD%E8%AF%91%E8%8B%B1_EN-US-2.png)

## 機能説明

### 1.レコーディング範囲
サーバー側のインターフェースで、レコーディングするルームIDのミックスストリーミングまたはルーム内ユーザーのシングルストリーミングを指定できます。
レコーディングを指定したルームIDに対して、サーバー側のインターフェースで、レコーディングするプレイヤーホワイトリストまたはレコーディングしないプレイヤーブラックリストを指定できます。

### 2.関連インターフェース

- [ ***StartRecord()*** ](https://www.tencentcloud.com/ko/document/product/607/53736)  **レコーディング起動**
このインターフェースのパラメータで、シングルストリーミングまたはミックスストリーミングのレコーディング、レコーディングするRoomID、サブスクリプションのホワイトリストユーザーIDまたはブラックリストユーザーIDを指定できます。

- [ ***StopRecord()***](https://www.tencentcloud.com/ko/document/product/607/53735) **レコーディング停止**
このインターフェースを使用し、指定したtaskidのレコーディングを停止できます。taskidを記録しなかった場合、DescribeTaskInfo()を呼び出して、指定したルームで実行しているレコーディングタスクのtaskidを取得する必要があります。

- [***ModifyRecordInfo()***](https://www.tencentcloud.com/ko/document/product/607/53737)  **レコーディング情報の更新**
このインターフェースを使用し、指定したtaskidのレコーディング情報を更新できます。具体的には、レコーディングタイプ、サブスクリプションのホワイトリストユーザーIDまたはブラックリストユーザーIDを更新できます。taskidを記録しなかった場合、DescribeTaskInfo()を呼び出して、指定したルームで実行しているレコーディングタスクのtaskidを取得する必要があります。

- [***DescribeTaskInfo()***](https://www.tencentcloud.com/ko/document/product/607/53738) **ルームのレコーディング情報の確認**
このインターフェースを使用し、指定したルームのレコーディング情報を確認できます。具体的には、実行中のレコーディングタスクのtaskid、サブスクリプションのホワイトリストユーザーIDまたはブラックリストユーザーIDを確認できます。

- [***DescribeRecordInfo()***](https://www.tencentcloud.com/ko/document/product/607/53739) **レコーディングタスク情報の確認**
このインターフェースを使用し、指定したtaskidのタスク情報を確認できます。具体的には、レコーディングタイプ、レコーディングしたルームID、レコーディングしたユーザーID、レコーディングファイルの情報を確認できます


### 3.レコーディングメカニズム

### レコーディングタスクの起動メカニズム
- [***StartRecord()***](https://www.tencentcloud.com/document/product/607/53736)インターフェースを呼び出すと、指定したルームのレコーディングタスクが起動します

### レコーディングタスクの停止メカニズム
- [***StopRecord()***](https://www.tencentcloud.com/document/product/607/53735)インターフェースを呼び出すと、指定したルームのレコーディングタスクが停止します


#### 録音ファイルの作成タイミング
- ルームミックスストリーミングの録音ファイル：ルームのレコーディングタスクが起動した後、ルームにユーザーがすでに存在している場合、ミックスストリーミングオーディオファイルが直ちに作成されます。ルームにユーザーが存在しない場合、最初のユーザーがルームに入った直後に、ミックスストリーミングオーディオファイルが作成されます。
- ユーザーシングルミックスストリーミングの録音ファイル：ルームのレコーディングタスクが起動した後、レコーディング範囲内のユーザーがルームに入ると、このユーザーのシングルストリーミングオーディオファイルが作成されます。


### レコーディングタスクのマルチパートメカニズム

- 単一オーディオファイルの長さが2時間になると、オーディオファイルを自動的にマルチパートに分割します
- ユーザーがマイクの接続を切断すると、ユーザーシングルストリーミングレコーディングオーディオを自動的にマルチパートに分割します。ユーザーがマイクの接続を確立すると、新しいマルチパートが作成されます
- レコーディング中のタスクが異常で中断した場合、タスクが自動的に再接続すると、新しいマルチパートが作成されます


#### レコーディングタスクのイベント通知メカニズム

- レコーディングタスクのイベントは、コールバックメカニズムにより、設定されたコールバックアドレスに通知されます。**レコーディング開始**、**レコーディング停止**、**レコーディングファイルアップロード完了**、これらのイベントが発生した場合、コールバック通知を受信します
- コールバック情報の詳細については、[レコーディングコールバックの説明]()をご参照ください


### 4.保存先

GMEサーバー側のレコーディングが完了した後、レコーディングしたオーディオファイルは、ご利用のアカウント配下の**COS**サービスの指定されたバケットに保存されます。バケットのリージョンは指定する必要があります。指定可能なリージョンのリストについては、[COSリージョンの説明](https://www.tencentcloud.com/document/product/436/6224)をご参照ください。


### 5.レコーディングファイルのフォーマット

- .mp3


### 6.レコーディングファイルの命名規則

- ユーザーシングルレコーティングファイル：bizid_roomid_userid/${タスクの開始時間}_${id}_audio.mp3
- ルームミックスストリーミングレコーティングファイル：bizid_roomid/${taskid}_${タスクの開始時間}_${id}_audio.mp3

 ***bizid:*** GMEアプリケーションID。[GMEコンソール](https://console.tencentcloud.com/gamegme)から取得できます
 ***roomid:*** 音声ルームID。リアルタイム音声サービスを使用する時に定義してGME SDKに渡します
 ***userid:*** プレイヤーID。リアルタイム音声サービスを使用する時に定義してGME SDKに渡します
 ***taskid:*** レコーティングタスクID。GMEレコーティングサービスにより生成されます。レコーティングタスクを正常に呼び出すたびに、1つ特殊なタスクIDが生成されます
 ***id:*** レコーティングタスクのマルチパートのシリアル番号。シリアル番号は0から始まります



## アクセス手順

<dx-steps>
-<dx-tag-link link="#StartRealTimeASR" tag="业务侧">コンソールでのレコーティングサービスの設定</dx-tag-link>
-<dx-tag-link link="#StartRealTimeASR" tag="业务侧">サーバー側のインターフェースの呼出しによるレコーティング範囲の定義</dx-tag-link>
-<dx-tag-link link="#callback" tag="业务侧">レコーティングタスクのコールバック受信（オプション）</dx-tag-link> 
-<dx-tag-link link="#result" tag="业务侧">レコーディングファイルの確認/管理</dx-tag-link>
</dx-steps>


### ステップ1：コンソールでのレコーティングサービスの設定

[GMEコンソール](https://console.tencentcloud.com/gamegme)にログインし、【サービス管理】メニューを開き、レコーディングサービスを有効にするアプリケーションの【設定】をクリックし、アプリケーションの詳細ページに進みます。
- #### レコーディングサービスの有効化/無効化

![](https://qcloudimg.tencent-cloud.cn/raw/4d72f57ae8f4463bc009d8ef8048232e.png)


ページで【音声レコーティングサービス】の**変更**をクリックし、レコーディングスイッチを**有効**に設定します。

レコーディングサービスを初めて有効にした場合、GMEはご利用の**COSサービス**にアクセスする許可を要求します。ポップアップしたダイアログで許可すると、サーバー側のレコーディングサービスが有効になります。


![](https://qcloudimg.tencent-cloud.cn/raw/5e38302c5e3b0013ba53bd29af14fab2.png)

- #### レコーディングファイルのストレージ設定

**レコーディングファイルのバケット**で**バインディング**をクリックします。
**バケットのバインディング**ダイアログで、既存COSバケット（既存バケットは[COSコンソール](https://console.tencentcloud.com/cos/bucket)で事前に作成する必要がある）のバインディングまたはバケットの新規作成ができます。

![](https://qcloudimg.tencent-cloud.cn/raw/30faa09353cdd31c537803f72bca25b2.png)

- #### レコーディングイベントのコールバック設定（オプション）
レコーディングサービスのイベントコールバックを受信するには、コールバックアドレスを設定する必要があります。操作パス：アプリケーションの詳細ページで、【音声レコーティングサービス】の**変更**をクリックし、**コールバックアドレス**で**変更**をクリックし、ポップアップしたダイアログにコールバックを受信するurlアドレスを入力します。現在、レコーディングタスクの完了状態のみに対して、イベントコールバックのメッセージをプッシュします。

![](https://qcloudimg.tencent-cloud.cn/raw/cbc0275b887b6bd402f41f9f5c325a5b.png)

- #### レコーディング範囲の設定
レコーディング範囲は、カスタムレコーディングとフルレコーディングを選択できます。この場合、カスタムレコーディングを選択してください。そうしないと、サーバー側に関連するインターフェースの呼出しに失敗します。


上記のように設定し、**保存**をクリックすると、レコーディングサービスが有効になります。レコーディングサービスを使用する必要があ➁場合、予定外の費用の発生を防ぐために、コンソールでレコーディングサービスのスイッチを**無効**にしてください。



### ステップ2：レコーティングタスクのコールバック受信（オプション）

**ステップ1**でコールバックアドレスを設定すれば、レコーディングタスクのイベントコールバックを受信できます。


### ステップ3：サーバー側のインターフェースの呼出しによるレコーティング範囲の定義
業務シーンの必要性に応じて、インターフェースを呼び出してください。呼出し順とプロセスの設計において、以下の点に注意してください：
- （1）既存のRoomIdに対するレコーディング開始リクエストのみをサポートします。RoomIdが存在しなければ、レコーディングタスクの作成に失敗します
- （2）自発的に呼び出してレコーディングを停止しなければ、ルームにユーザーがいる限り、レコーディングプロセスはずっと実行します。ルーム内のユーザーが全部退出した後、元のレコーディングタスクのプロセスは12時間保持されます。保持中に、ユーザーが改めてルームに入れば、レコーディングが自動的に開始します。レコーディングプロセスの保持時間が過ぎた後、ユーザーがルームに入っても、レコーディングは自動的に開始しません。



### ステップ4：レコーティングファイルの確認/管理

完全なオーディオファイルはレコーディングタスクが終了して数分以内に作成できます。ご利用の[COSコンソール](https://console.tencentcloud.com/cos/bucket)で、レコーディングファイルを確認、管理できます。







